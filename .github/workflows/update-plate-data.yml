name: Update Japanese License Plate Data

on:
  schedule:
    # æ¯é€±æ—¥æ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 pandas lxml html5lib

    - name: Fetch and compare data using MediaWiki API
      id: check-data
      run: |
        python -m scripts.fetch_wiki_data

    - name: Create Pull Request if changes detected
      if: steps.check-data.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "è‡ªå‹•æ›´æ–°: ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆç™»éŒ²åœ°åãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°"
        title: "ğŸš— ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆç™»éŒ²åœ°åãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ›´æ–°"
        body: |
          ## ğŸ“‹ æ¦‚è¦

          MediaWiki APIã‚’ä½¿ç”¨ã—ã¦Wikipediaã®ã€Œæ—¥æœ¬ã®ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã€ãƒšãƒ¼ã‚¸ã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸã€‚

          ## ğŸ”„ å¤‰æ›´å†…å®¹

          ${{ steps.check-data.outputs.changes-summary }}

          ## ğŸ“… ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

          - **å–å¾—æ—¥æ™‚**: ${{ steps.check-data.outputs.fetch-time }}
          - **Wikipediaæœ€çµ‚æ›´æ–°**: ${{ steps.check-data.outputs.wiki-last-modified }}
          - **Wikipediaæœ€çµ‚æ›´æ–°è€…**: ${{ steps.check-data.outputs.wiki-last-user }}
          - **ã‚½ãƒ¼ã‚¹URL**: https://ja.wikipedia.org/wiki/æ—¥æœ¬ã®ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§
          - **APIä½¿ç”¨**: MediaWiki API (https://ja.wikipedia.org/w/api.php)

          ## âœ… ç¢ºèªäº‹é …

          - [ ] æ–°ã—ã„ç™»éŒ²åœ°åãŒæ­£ã—ãè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
          - [ ] èª­ã¿ä»®åãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
          - [ ] éƒ½é“åºœçœŒã¨é‹è¼¸æ”¯å±€ã®æƒ…å ±ãŒæ­£ç¢ºã§ã‚ã‚‹
          - [ ] CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒç¶­æŒã•ã‚Œã¦ã„ã‚‹

          ---

          ã“ã®å¤‰æ›´ã¯è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
        branch: auto-update-plate-data
        delete-branch: true
        committer: GitHub Actions <actions@github.com>
        author: GitHub Actions <actions@github.com>

    - name: Comment on no changes
      if: steps.check-data.outputs.changes == 'false'
      run: |
        echo "å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€æ–°ã®çŠ¶æ…‹ã§ã™ã€‚"
