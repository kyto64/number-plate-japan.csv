name: Update Japanese License Plate Data

on:
  schedule:
    # æ¯Žé€±æ—¥æ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 pandas lxml html5lib

    - name: Fetch and compare data using MediaWiki API
      id: check-data
      run: |
        python -m scripts.fetch_wiki_data

    - name: Update last check timestamp with changes
      if: steps.check-data.outputs.changes == 'true'
      run: |
        echo "ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æœ€çµ‚ç¢ºèªæ—¥ã‚’æ›´æ–°ã—ã¾ã™ã€‚"

        # ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—ï¼ˆJSTï¼‰
        CURRENT_TIME=$(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')

        # LAST_CHECK.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
        cat > LAST_CHECK.md << EOF
        # æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ç¢ºèªæ—¥

        ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦ç¶­æŒã•ã‚Œã¾ã™ã€‚

        **æœ€çµ‚ç¢ºèªæ—¥æ™‚**: ${CURRENT_TIME}
        **ç¢ºèªçµæžœ**: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’æ¤œå‡ºã—ã¦ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: https://ja.wikipedia.org/wiki/æ—¥æœ¬ã®ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§

        EOF

        # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add LAST_CHECK.md

    - name: Create Pull Request if changes detected
      if: steps.check-data.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "è‡ªå‹•æ›´æ–°: ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆç™»éŒ²åœ°åãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°"
        title: "ðŸš— ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆç™»éŒ²åœ°åãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ›´æ–°"
        body: |
          ## ðŸ“‹ æ¦‚è¦

          MediaWiki APIã‚’ä½¿ç”¨ã—ã¦Wikipediaã®ã€Œæ—¥æœ¬ã®ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã€ãƒšãƒ¼ã‚¸ã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸã€‚

          ## ðŸ”„ å¤‰æ›´å†…å®¹

          ${{ steps.check-data.outputs.changes-summary }}

          ## ðŸ“… ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

          - **å–å¾—æ—¥æ™‚**: ${{ steps.check-data.outputs.fetch-time }}
          - **Wikipediaæœ€çµ‚æ›´æ–°**: ${{ steps.check-data.outputs.wiki-last-modified }}
          - **Wikipediaæœ€çµ‚æ›´æ–°è€…**: ${{ steps.check-data.outputs.wiki-last-user }}
          - **ã‚½ãƒ¼ã‚¹URL**: https://ja.wikipedia.org/wiki/æ—¥æœ¬ã®ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§
          - **APIä½¿ç”¨**: MediaWiki API (https://ja.wikipedia.org/w/api.php)

          ## âœ… ç¢ºèªäº‹é …

          - [ ] æ–°ã—ã„ç™»éŒ²åœ°åãŒæ­£ã—ãè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
          - [ ] èª­ã¿ä»®åãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
          - [ ] éƒ½é“åºœçœŒã¨é‹è¼¸æ”¯å±€ã®æƒ…å ±ãŒæ­£ç¢ºã§ã‚ã‚‹
          - [ ] CSVãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãŒç¶­æŒã•ã‚Œã¦ã„ã‚‹

          ---

          ã“ã®å¤‰æ›´ã¯è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
        branch: auto-update-plate-data
        delete-branch: true
        committer: GitHub Actions <actions@github.com>
        author: GitHub Actions <actions@github.com>

    - name: Update last check timestamp
      if: steps.check-data.outputs.changes == 'false'
      run: |
        echo "å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æœ€çµ‚ç¢ºèªæ—¥ã‚’æ›´æ–°ã—ã¾ã™ã€‚"

        # ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—ï¼ˆJSTï¼‰
        CURRENT_TIME=$(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')

        # LAST_CHECK.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
        cat > LAST_CHECK.md << EOF
        # æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ç¢ºèªæ—¥

        ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦ç¶­æŒã•ã‚Œã¾ã™ã€‚

        **æœ€çµ‚ç¢ºèªæ—¥æ™‚**: ${CURRENT_TIME}
        **ç¢ºèªçµæžœ**: ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãªã—
        **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: https://ja.wikipedia.org/wiki/æ—¥æœ¬ã®ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§

        EOF

        # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        git add LAST_CHECK.md
        if git diff --staged --quiet; then
          echo "æœ€çµ‚ç¢ºèªæ—¥ã«å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        else
          git commit -m "ðŸ¤– æœ€çµ‚ç¢ºèªæ—¥ã‚’æ›´æ–°: ${CURRENT_TIME} (å¤‰æ›´ãªã—)"
          git push origin main
          echo "æœ€çµ‚ç¢ºèªæ—¥ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${CURRENT_TIME}"
        fi
